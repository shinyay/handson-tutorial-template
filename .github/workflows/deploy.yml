name: Build and Deploy Codelabs

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Install claat
      run: go install github.com/googlecodelabs/tools/claat@latest

    - name: Export tutorials
      run: |
        mkdir -p dist
        find docs -name '*.md' -exec claat export -o dist {} +

    - name: Create tutorial index
      run: |
        cat > dist/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Codelabs Tutorials</title>
            <style>
                body { 
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
                    margin: 0; padding: 40px; background: #f5f5f5; 
                }
                .header { 
                    text-align: center; margin-bottom: 40px; 
                    background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }
                .tutorials { 
                    display: grid; 
                    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
                    gap: 20px; 
                }
                .tutorial-card { 
                    background: white;
                    border: 1px solid #ddd; 
                    border-radius: 8px; 
                    padding: 20px; 
                    text-decoration: none; 
                    color: inherit;
                    transition: all 0.2s ease;
                }
                .tutorial-card:hover { 
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
                    transform: translateY(-2px);
                }
                .tutorial-title { 
                    font-size: 1.2em; 
                    font-weight: bold; 
                    margin-bottom: 10px; 
                    color: #1976d2;
                }
                .tutorial-meta { 
                    color: #666; 
                    font-size: 0.9em; 
                }
                .badge {
                    display: inline-block;
                    background: #e3f2fd;
                    color: #1976d2;
                    padding: 4px 12px;
                    border-radius: 16px;
                    font-size: 0.8em;
                    margin-top: 10px;
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ðŸ“š Codelabs Tutorial Framework</h1>
                <p>Interactive tutorials and hands-on coding experiences</p>
                <p><a href="https://github.com/shinyay/handson-tutorial-template">View on GitHub</a></p>
            </div>
            <div class="tutorials">
        EOF
        
        for dir in dist/*/; do
            if [ -d "$dir" ]; then
                tutorial_id=$(basename "$dir")
                echo "                <a href=\"$tutorial_id/\" class=\"tutorial-card\">" >> dist/index.html
                echo "                    <div class=\"tutorial-title\">$(echo $tutorial_id | sed 's/-/ /g' | sed 's/\b\w/\U&/g')</div>" >> dist/index.html
                echo "                    <div class=\"tutorial-meta\">Interactive Tutorial</div>" >> dist/index.html
                echo "                    <span class=\"badge\">Codelabs</span>" >> dist/index.html
                echo "                </a>" >> dist/index.html
            fi
        done
        
        echo "            </div>" >> dist/index.html
        echo "        </body>" >> dist/index.html
        echo "        </html>" >> dist/index.html

    - name: Setup Pages
      uses: actions/configure-pages@v3

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v2
      with:
        path: './dist'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2